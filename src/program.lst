program.lst - generated by MGTEK Assembler ASM11 V1.26 Build 144 for WIN32 (x86) - Thu Dec 04 16:29:56 2025

    1:          =00000000              PRG_START   EQU $0000   ; Internal ROM start
    2:                                 
    3:          =00001000              PORTA       EQU $1000   ; PORTA controls OE'
    4:          =00001004              PORTB       EQU $1004   ; PORTB controls 2764 address lines
    5:          =00001003              PORTC       EQU $1003   ; PORTC receives/sends data from/to 2764
    6:          =00001007              DDRC        EQU $1007   ; PORTC direction pins
    7:                                 
    8:          =000000E0              DATA        EQU $00E0   ; Location to store 25 bytes in on-chip memory
    9:                                 
   10:                                 ; Serial communications
   11:                                 ; https://controls.ame.nd.edu/microcontroller/main/node25.html
   12:          =0000102E              SCSR        EQU $102E ; Status register, TDRE is bit 7
   13:          =0000102F              SCDR        EQU $102F
   14:                                 
   15:          =000000E0                  ORG DATA
   16:                                             ; 25-element array for the data
   17:     00E0 AA BB CC DD EE AA      ARRAY       DB $AA, $BB, $CC, $DD, $EE, $AA, $BB, $CC, $DD, $EE
           00E6 BB CC DD EE 
   18:     00EA AA BB CC DD EE AA                  DB $AA, $BB, $CC, $DD, $EE, $AA, $BB, $CC, $DD, $EE
           00F0 BB CC DD EE 
   19:     00F4 AA BB CC DD EE                     DB $AA, $BB, $CC, $DD, $EE
   20:                                 
   21:          =00000000                  ORG PRG_START
   22:                                             ; Set PORTA. PROG_EN' and CE' are activated at program start.
   23:                                             ; Bit 6: PROG_EN = 1
   24:                                             ; Bit 5: CE' = 0
   25:                                             ; Bit 4: OE' = 1
   26:     0000 86 50                              LDAA #%01010000
   27:     0002 B7 1000                            STAA PORTA
   28:                                 
   29:     0005 CE 0000                            LDX #0
   30:     0008 E6 E0                  NEXT_DATA   LDAB DATA,X ; Get first byte to store...
   31:     000A F7 1003                            STAB PORTC  ; ...and place on PORTC
   32:                                 
   33:                                             
   34:     000D FF 1004                            STX PORTB   ; Index X is also the target address on the 2764
   35:                                 
   36:                                             
   37:                                 
   38:     0010 86 01                              LDAA #1     ; Start at n = 1
   39:     0012                        RETRY       
   40:     0012 36                                 PSHA        ; Push current n to stack
   41:                                             
   42:     0013 86 50                              LDAA #%01010000
   43:     0015 B7 1000                            STAA PORTA
   44:                                 
   45:     0018 86 FF                              LDAA #$FF
   46:     001A B7 1007                            STAA DDRC   ; Set all PORTC pins to output
   47:                                 
   48:     001D E6 E0                              LDAB DATA,X ; Get first byte to store...
   49:     001F F7 1003                            STAB PORTC  ; ...and place on PORTC
   50:                                 
   51:                                             
   52:                                 
   53:                                             ; By this point, HC11 is outputting data and adddress to the 2764
   54:                                 
   55:     0022 86 01                              LDAA #1     ; ] 1 ms
   56:     0024 8D 4E                              BSR PULSE   ; ] pulse
   57:                                             
   58:     0026 8D 6C                              BSR LONG_DELAY
   59:     0028 8D 6A                              BSR LONG_DELAY
   60:     002A 8D 68                              BSR LONG_DELAY
   61:                                 
   62:     002C 86 00                              LDAA #$00
   63:     002E B7 1007                            STAA DDRC   ; Set all PORTC pins to input
   64:                                             
   65:     0031 B7 1000                            STAA PORTA
   66:                                 
   67:     0034 8D 5E                              BSR LONG_DELAY
   68:     0036 8D 5C                              BSR LONG_DELAY
   69:     0038 8D 5A                              BSR LONG_DELAY
   70:                                 
   71:                                             ; By this point, ACCB has the actual data bit for reference
   72:                                             ; Compare against PORTC to verify
   73:                                 
   74:                                             
   75:     003A 8D 58                              BSR LONG_DELAY
   76:                                             
   77:     003C CE 0000                            LDX #0
   78:     003F FF 1004                            STX PORTB
   79:                                             
   80:     0042 01                                 NOP
   81:     0043 01                                 NOP
   82:     0044 01                                 NOP
   83:     0045 01                                 NOP
   84:                                             
   85:     0046 B6 1003                            LDAA PORTC
   86:     0049 B7 102F                            STAA SCDR ; Writeback the byte to serial data register
   87:                                             
   88:     004C 32                                 PULA        ; Retrieve current n from stack
   89:                                             
   90:                                             
   91:                                             
   92:                                             
   93:                                             
   94:                                             
   95:                                             
   96:                                             
   97:     004D F1 1003                            CMPB PORTC
   98:     0050 27 0E                              BEQ NEXT
   99:                                             
  100:                                             ; Wait for SCI transmit buffer to be empty (TDRE == 1)
  101:                                             ; This means byte was transmitted successfully
  102:     0052 F6 102E                WAIT_SCI_2  LDAB SCSR ; Get SCI status register
  103:     0055 C4 80                              ANDB #$80 ; Bit mask of #$80 looks at bit 7 (TDRE) of SCSR
  104:     0057 27 F9                              BEQ WAIT_SCI_2 ; If TDRE == 0, go back and wait some more
  105:                                             
  106:                                             
  107:                                 
  108:                                             
  109:     0059 4C                                 INCA        ; n++
  110:     005A 81 1A                              CMPA #26    ; n > 25
  111:     005C 27 0F                              BEQ FAIL
  112:                                 
  113:     005E 20 B2                              BRA RETRY
  114:                                 
  115:     0060 C6 03                  NEXT        LDAB #3     ; ACCB = 3, ACCA = n
  116:     0062 3D                                 MUL         ; D = 3*n
  117:     0063 16                                 TAB         ; ACCA = 3*n
  118:     0064 8D 0E                              BSR PULSE   ; 3*n ms pulse
  119:     0066 08                                 INX
  120:     0067 8C 0019                            CPX #25     ; Address > $18
  121:     006A 26 9C                              BNE NEXT_DATA
  122:                                 
  123:     006C 01                     SUCCESS     NOP
  124:                                 
  125:     006D 01                     FAIL        NOP
  126:                                 
  127:     006E 86 10                              LDAA #%00010000
  128:     0070 B7 1000                            STAA PORTA
  129:                                 
  130:     0073 CF                                 STOP
  131:                                 
  132:                                 ; ------------------------------------------------------------------------------
  133:                                 ; Subroutine PULSE
  134:                                 ; Sends an approx. n-ms pulse at bit 7 of PORTB
  135:                                 ; ((6 + (3 + (3 + 3) * 332 + 2 + 3) * 1) + 5 + 2 + 4) / 2 MHz ~= n ms
  136:                                 ;
  137:                                 ; Parameters:
  138:                                 ;   ACCA: Duration of pulse in ms
  139:                                 ; ------------------------------------------------------------------------------
  140:                                 
  141:     0074 36                     PULSE       PSHA            ; Save accumulators
  142:     0075 37                                 PSHB
  143:     0076 3C                                 PSHX
  144:     0077 F6 1004                            LDAB PORTB      ; Save address lines
  145:                                             
  146:     007A C4 7F                              ANDB #$7F       ; 2 cycles --- reset bit 7
  147:     007C F7 1004                            STAB PORTB
  148:     007F 8D 09                              BSR DELAY_1MS   ; 6 cycles
  149:     0081 CA 80                              ORAB #$80       ; Set bit 7 to 1
  150:     0083 F7 1004                            STAB PORTB      ; 4 cycles
  151:     0086 38                                 PULX
  152:     0087 33                                 PULB
  153:     0088 32                                 PULA
  154:     0089 39                                 RTS
  155:                                 
  156:     008A CE 014C                DELAY_1MS   LDX #332        ; 3 cycles
  157:     008D 09                     DELAY_LOOP  DEX             ; 3 cycles
  158:     008E 26 FD                              BNE DELAY_LOOP  ; 3 cycles
  159:     0090 4A                                 DECA            ; 2 cycles
  160:     0091 26 F7                              BNE DELAY_1MS   ; 3 cycles
  161:     0093 39                                 RTS             ; 5 cycles
  162:                                             
  163:                                             
  164:     0094 3C                     LONG_DELAY  PSHX
  165:     0095 CE 7FFF                            LDX #$7FFF
  166:     0098 09                     LOOPS       DEX
  167:     0099 26 FD                              BNE LOOPS
  168:     009B 38                                 PULX
  169:     009C 39                                 RTS
  170:                                 
